@model UserViewModel

@{
    ViewData["Title"] = "Profile";
    var isProfileOwner = Model.Id == ViewBag.UserId;
    var isAdmin = User.IsInRole("Admin");
    var canViewFullProfile = isProfileOwner || isAdmin;
}

<div class="container bg-dark-1 py-5">
    <div class="card-body">

        <!-- Tabs for Profile Sections -->
        <ul class="nav nav-tabs justify-content-center mb-4" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active text-uppercase" id="account-details-tab" data-bs-toggle="tab" href="#account-details" role="tab" aria-controls="account-details" aria-selected="true">Account</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link text-uppercase" id="profile-details-tab" data-bs-toggle="tab" href="#profile-details" role="tab" aria-controls="profile-details" aria-selected="false">Profile</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link text-uppercase" id="friends-tab" data-bs-toggle="tab" href="#friends" role="tab" aria-controls="friends" aria-selected="false">Friends</a>
            </li>
        </ul>

        <!-- Tab Contents -->
        <div class="tab-content" id="profileTabsContent">

            <!-- Account Details Tab -->
            <div class="tab-pane fade show active" id="account-details" role="tabpanel" aria-labelledby="account-details-tab">
                <div class="row mt-4 animate__animated animate__fadeIn">
                    <!-- Left Column: Total Balance and Wallets -->
                    <div class="col-md-6 d-flex flex-column justify-content-between">
                        <!-- Total Balance with Wallet Icon -->
                        <div class="card bg-dark-3 text-white mb-4 shadow-sm">
                            <div class="d-flex justify-content-center align-items-center">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-wallet2 display-3 me-3"></i>
                                    <div>
                                        <h5>Total Balance</h5>
                                        <h3>$@Model.TotalBalance.ToString()</h3>
                                    </div>
                                </div>

                                <div class="card-body d-flex align-items-center">
                                    <a href="@Url.Action("Cards","User")" style="color: white;">
                                        <i class="bi bi-credit-card display-3 me-3"></i>
                                    </a>
                                    <div>
                                        <h5>Total Cards</h5>
                                        <h3>@Model.Cards.Count()</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Carousel for Wallets -->
                        <div class="card bg-dark-3 text-white mb-4 shadow-sm flex-grow-1">
                            <div class="card-body">
                                <h5 class="mb-3">Wallets</h5>
                                <div id="walletCarousel" class="carousel slide" data-bs-ride="carousel">
                                    <div class="carousel-inner">
                                        @if (Model.Wallets.Any())
                                        {
                                            for (int i = 0; i < Model.Wallets.Count; i++)
                                            {
                                                var wallet = Model.Wallets.ElementAt(i);
                                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                                    <div class="card text-white w-50 bg-dark-1 mx-auto">
                                                        <div class="card-body d-flex gap-3 align-items-center justify-content-center">
                                                            <span>@wallet.Name</span>
                                                            <span class="badge bg-secondary">@wallet.Balance.ToString("N2") @wallet.Currency</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="carousel-item active">
                                                <div class="card bg-dark-1 text-white">
                                                    <div class="card-body text-center">
                                                        <span>No wallets available</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <a class="carousel-control-prev" href="#walletCarousel" role="button" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </a>
                                    <a class="carousel-control-next" href="#walletCarousel" role="button" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Account Information -->
                    <div class="col-md-6">
                        <div class="card bg-dark-3 text-white mb-4 shadow-sm pb-5">
                            <div class="card-body">
                                <h5 class="mb-3">Account Information</h5>
                                <p><strong>Username:</strong> @Model.Username</p>
                                <p><strong>Email:</strong> @Model.Email</p>
                                <p><strong>User Status:</strong> @Model.Role.ToString()</p>
                                <p><strong>Verification Status:</strong> @Model.VerificationStatus.ToString()</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Account Actions -->
                <div class="row animate__animated animate__fadeInUp">
                    <div class="col-md-12">
                        <h4 class="mb-3">Actions</h4>
                        @if (Model.Id != ViewBag.UserId)
                        {
                            <a href="@Url.Action("SendMoney", "Transaction", new { recipientId = Model.Id })" class="btn btn-primary btn-sm mb-2 me-2">Send Money</a>
                            <a href="@Url.Action("RequestMoney", "Transaction", new { senderId = Model.Id })" class="btn btn-primary btn-sm mb-2 me-2">Request Money</a>
                            <form asp-controller="User" asp-action="SendFriendRequest" method="post" class="d-inline">
                                <input type="hidden" name="contactId" value="@Model.Id" />
                                <button type="submit" class="btn btn-success btn-sm mb-2 me-2">Add as Friend</button>
                            </form>
                        }
                        @if (Model.Role == UserRole.Admin.ToString())
                        {
                            <a href="@Url.Action("UnbanUser", "Admin", new { userId = Model.Id })" class="btn btn-warning btn-sm mb-2 me-2">Unban User</a>
                            <a href="@Url.Action("BanUser", "Admin", new { userId = Model.Id })" class="btn btn-danger btn-sm mb-2 me-2">Ban User</a>
                        }
                        @if (Model.Id == ViewBag.UserId || Model.Role == UserRole.Admin.ToString())
                        {
                            <div class="d-flex justify-content-between mt-4">
                                <div>
                                    <a href="@Url.Action("ChangeUsername", "User", new { userId = Model.Id })" class="btn btn-secondary btn-sm mb-2 me-2">Change Username</a>
                                    <a href="@Url.Action("ChangePassword", "User", new { userId = Model.Id })" class="btn btn-secondary btn-sm mb-2 me-2">Change Password</a>
                                </div>
                                <a href="@Url.Action("DeleteAccount", "User", new { id = Model.Id })" class="btn btn-danger btn-sm mb-2">Delete Account</a>
                            </div>
                        }
                    </div>
                </div>
            </div>



            <!-- Profile Details Tab -->
            <div class="tab-pane fade animate__animated animate__fadeIn" id="profile-details" role="tabpanel" aria-labelledby="profile-details-tab">
                <div class="d-flex gap-4 w-75 mx-auto">
                    <!-- User Image -->
                    <div class="col-md-4 d-flex flex-column align-items-center mb-4 card bg-dark-3 text-white mb-4 shadow-sm p-3">
                        <img src="@Model.UserProfile.PhotoUrl" alt="Profile Picture" class="img-thumbnail mb-3 shadow-lg" style="max-width: 100%;">
                        @if (canViewFullProfile)
                        {
                            <a href="@Url.Action("EditProfile", "User", new { userId = Model.Id })" class="btn btn-secondary">Edit Profile</a>
                        }
                    </div>

                    <!-- Personal Information -->
                    <div class="col-md-4 card bg-dark-3 text-white mb-4 shadow-sm p-3">
                        <h4 class="mb-3">Personal Information</h4>
                        <p><strong>First Name:</strong> @Model.UserProfile.FirstName</p>
                        <p><strong>Last Name:</strong> @Model.UserProfile.LastName</p>
                        <p><strong>Date of Birth:</strong> @Model.UserProfile.DateOfBirth.ToString("MMMM dd, yyyy")</p>
                        @if (canViewFullProfile)
                        {
                            <p><strong>Phone Number:</strong> @Model.UserProfile.PhoneNumber</p>
                        }
                    </div>

                    <!-- Address Details -->
                    @if (canViewFullProfile)
                    {
                        <div class="col-md-4 card bg-dark-3 text-white mb-4 shadow-sm p-3">
                            <h4 class="mb-3">Address Details</h4>
                            <p><strong>Street:</strong> @Model.UserProfile.Street</p>
                            <p><strong>City:</strong> @Model.UserProfile.City</p>
                            <p><strong>State:</strong> @Model.UserProfile.State</p>
                            <p><strong>Country:</strong> @Model.UserProfile.Country</p>
                            <p><strong>Postal Code:</strong> @Model.UserProfile.PostalCode</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Friends Tab -->
            <div class="tab-pane fade" id="friends" role="tabpanel" aria-labelledby="friends-tab">
                <div class="col-md-12">
                    <h4 class="mt-4">Friends List</h4>

                    <!-- Search Form -->
                    <form asp-controller="User" asp-action="SearchFriends" method="get" class="mb-4">
                        <input type="hidden" name="userId" value="@Model.Id" />
                        <div class="input-group">
                            <input type="text" name="searchTerm" class="form-control" placeholder="Search friends by name or email..." aria-label="Search friends">
                            <button class="btn btn-secondary" type="submit">Search</button>
                        </div>
                    </form>

                    <!-- Friends List Table -->
                    @if (Model.Contacts != null && Model.Contacts.Any())
                    {
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Status</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var contact in Model.Contacts)
                                {
                                    <tr>
                                        <td>@contact.Contact.Username</td>
                                        <td>@contact.Status.ToString()</td>
                                        <td>
                                            <div class="description-container">
                                                <!-- Display Mode -->
                                                @{
                                                    var context = @contact.Description ?? "Click to add a description";
                                                }
                                                <span class="description-text" onclick="showEditForm(this)">
                                                    @context
                                                </span>

                                                <!-- Edit Mode (Hidden by Default) -->
                                                <div class="description-form" style="display: none;">
                                                    <form id="descriptionForm-@contact.ContactId" asp-controller="User" asp-action="UpdateFriendDescription" method="post" class="d-flex description-form" style="display: none;" onsubmit="saveDescription(event, @contact.ContactId)">
                                                        <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                        <input type="text" name="description" value="@contact.Description" class="form-control form-control-sm" placeholder="Enter description" maxlength="30" />
                                                        <button type="submit" class="btn btn-sm btn-outline-success ms-2">Save</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @if (contact.Status == FriendRequestStatus.Pending && contact.Sender.Id == contact.ContactId)
                                            {
                                                <form asp-controller="User" asp-action="AcceptFriendRequest" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.SenderId" />
                                                    <button type="submit" class="btn btn-success btn-sm">Accept</button>
                                                </form>
                                                <form asp-controller="User" asp-action="DenyFriendRequest" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-danger btn-sm">Deny</button>
                                                </form>
                                            }
                                            @if (contact.Status == FriendRequestStatus.Accepted)
                                            {
                                                <form asp-controller="Wallet" asp-action="SendMoney" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-success btn-sm">+ Send Money</button>
                                                </form>
                                                <form asp-controller="Wallet" asp-action="ReceiveMoney" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-warning btn-sm">- Request Money</button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">No friends found.</p>
                    }
                </div>
            </div>
        </div>

    </div>
</div>
