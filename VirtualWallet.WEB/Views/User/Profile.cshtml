@model UserViewModel

@{
    ViewData["Title"] = "Profile";
    var isProfileOwner = Model.Id == ViewBag.UserId;
    var isAdmin = User.IsInRole("Admin");
    var canViewFullProfile = isProfileOwner || isAdmin;
}

<div class="container bg-dark-1">
    <div class="card-body">


        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="account-details-tab" data-bs-toggle="tab" href="#account-details" role="tab" aria-controls="account-details" aria-selected="true">Account</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="profile-details-tab" data-bs-toggle="tab" href="#profile-details" role="tab" aria-controls="profile-details" aria-selected="false">Profile</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="friends-tab" data-bs-toggle="tab" href="#friends" role="tab" aria-controls="friends" aria-selected="false">Friends</a>
            </li>
        </ul>

        <div class="tab-content" id="profileTabsContent">
            <!-- User Account Tab -->
            <div class="tab-pane fade show active" id="account-details" role="tabpanel" aria-labelledby="account-details-tab">
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h4>Account Information</h4>
                        <p><strong>Username:</strong> @Model.Username</p>
                        <p><strong>Email:</strong> @Model.Email</p>
                        <p><strong>User Status:</strong> @Model.Role.ToString()</p>
                        <p><strong>Verification Status:</strong> @Model.VerificationStatus.ToString()</p>
                    </div>
                </div>

                <hr />

                <!-- Account Actions -->
                <div class="row">
                    <div class="col-md-12">
                        <h4>Actions</h4>
                        @if (Model.Id != ViewBag.UserId)
                        {
                            <a href="@Url.Action("SendMoney", "Transaction", new { recipientId = Model.Id })" class="btn btn-primary btn-sm mb-2">Send Money</a>
                            <a href="@Url.Action("RequestMoney", "Transaction", new { senderId = Model.Id })" class="btn btn-primary btn-sm mb-2">Request Money</a>
                            <form asp-controller="User" asp-action="SendFriendRequest" method="post" class="d-inline">
                                <input type="hidden" name="contactId" value="@Model.Id" />
                                <button type="submit" class="btn btn-success btn-sm mb-2">Add as Friend</button>
                            </form>
                        }
                        @if (Model.Role == UserRole.Admin.ToString())
                        {
                            <a href="@Url.Action("UnbanUser", "Admin", new { userId = Model.Id })" class="btn btn-warning btn-sm mb-2">Unban User</a>
                            <a href="@Url.Action("BanUser", "Admin", new { userId = Model.Id })" class="btn btn-danger btn-sm mb-2">Ban User</a>
                        }
                        @if (Model.Id == ViewBag.UserId || Model.Role == UserRole.Admin.ToString())
                        {
                            <div class="d-flex justify-content-between">
                                <div>

                                <a href="@Url.Action("ChangeUsername", "User", new { userId = Model.Id })" class="btn btn-secondary btn-sm">Change Username</a>
                                <a href="@Url.Action("ChangePassword", "User", new { userId = Model.Id })" class="btn btn-secondary btn-sm">Change Password</a>
                                </div>
                                <a href="@Url.Action("DeleteAccount", "User", new { id = Model.Id })" class="btn btn-danger btn-sm">Delete Account</a>

                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- User Profile Tab -->
            <div class="tab-pane fade" id="profile-details" role="tabpanel" aria-labelledby="profile-details-tab">
                <div class="row mt-4">
                    <!-- Left Column: User Image (always visible) -->
                    <div class="col-md-4 d-flex flex-column align-items-center">
                        <img src="@Model.UserProfile.PhotoUrl" alt="Profile Picture" class="img-thumbnail mb-3" />
                        @if (canViewFullProfile)
                        {
                            <a href="@Url.Action("EditProfile", "User", new { userId = Model.Id })" class="btn btn-secondary btn-block">Edit Profile</a>
                        }
                    </div>

                    <!-- Middle Column: Personal Information (always visible) -->
                    <div class="col-md-4">
                        <h4>Personal Information</h4>
                        <p><strong>First Name:</strong> @Model.UserProfile.FirstName</p>
                        <p><strong>Last Name:</strong> @Model.UserProfile.LastName</p>
                        <p><strong>Date of Birth:</strong> @Model.UserProfile.DateOfBirth.ToString("MMMM dd, yyyy")</p>
                        @if (canViewFullProfile)
                        {
                            <p><strong>Phone Number:</strong> @Model.UserProfile.PhoneNumber</p>
                        }
                    </div>

                    @if (canViewFullProfile)
                    {
                        <!-- Right Column: Address Details (only visible to profile owner or admin) -->
                        <div class="col-md-4">
                            <h4>Address Details</h4>
                            <p><strong>Street:</strong> @Model.UserProfile.Street</p>
                            <p><strong>City:</strong> @Model.UserProfile.City</p>
                            <p><strong>State:</strong> @Model.UserProfile.State</p>
                            <p><strong>Country:</strong> @Model.UserProfile.Country</p>
                            <p><strong>Postal Code:</strong> @Model.UserProfile.PostalCode</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Friends Tab -->
            <div class="tab-pane fade" id="friends" role="tabpanel" aria-labelledby="friends-tab">
                <div class="col-md-12">
                    <h4 class="mt-4">Friends List</h4>

                    <!-- Search Form -->
                    <form asp-controller="User" asp-action="SearchFriends" method="get" class="mb-3">
                        <input type="hidden" name="userId" value="@Model.Id" />
                        <div class="input-group">
                            <input type="text" name="searchTerm" class="form-control" placeholder="Search friends by name or email..." aria-label="Search friends">
                            <button class="btn btn-secondary" type="submit">Search</button>
                        </div>
                    </form>

                    <!-- Friends List Table -->
                    @if (Model.Contacts != null && Model.Contacts.Any())
                    {
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Status</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var contact in Model.Contacts)
                                {
                                    <tr>
                                        <td>@contact.Contact.Username</td>
                                        <td>@contact.Status.ToString()</td>
                                        <td>
                                            <div class="description-container">
                                                <!-- Display Mode -->
                                                @{
                                                    var context = @contact.Description ?? "Click to add a description";
                                                }
                                                <span class="description-text" onclick="showEditForm(this)">
                                                    @context
                                                </span>

                                                <!-- Edit Mode (Hidden by Default) -->
                                                <div class="description-form" style="display: none;">
                                                    <form id="descriptionForm-@contact.ContactId" asp-controller="User" asp-action="UpdateFriendDescription" method="post" class="d-flex description-form" style="display: none;" onsubmit="saveDescription(event, @contact.ContactId)">
                                                        <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                        <input type="text" name="description" value="@contact.Description" class="form-control form-control-sm" placeholder="Enter description" maxlength="30" />
                                                        <button type="submit" class="btn btn-sm btn-outline-success ms-2">Save</button>
                                                    </form>
                                                </div>
                                            </div>



                                        </td>
                                        <td>
                                            @if (contact.Status == FriendRequestStatus.Pending && contact.Sender.Id == contact.ContactId)
                                            {
                                                <form asp-controller="User" asp-action="AcceptFriendRequest" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.SenderId" />
                                                    <button type="submit" class="btn btn-success btn-sm">Accept</button>
                                                </form>
                                                <form asp-controller="User" asp-action="DenyFriendRequest" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-danger btn-sm">Deny</button>
                                                </form>
                                            }
                                            @if (contact.Status == FriendRequestStatus.Accepted)
                                            {
                                                <form asp-controller="Wallet" asp-action="SendMoney" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-success btn-sm">+ Send Money</button>
                                                </form>
                                                <form asp-controller="Wallet" asp-action="ReceiveMoney" method="post" class="d-inline">
                                                    <input type="hidden" name="contactId" value="@contact.ContactId" />
                                                    <button type="submit" class="btn btn-warning btn-sm">- Request Money</button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No friends found.</p>
                    }
                </div>


                <hr />
                <p>Recruit a friend TODO</p>
            </div>

        </div>
    </div>
</div>


